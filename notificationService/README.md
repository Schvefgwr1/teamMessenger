# Notification Service

Notification Service - —ç—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ TeamMessenger. –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Kafka –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ HTML email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Kafka** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- **–û—Ç–ø—Ä–∞–≤–∫–∞ HTML email** - –∫—Ä–∞—Å–∏–≤—ã–µ, responsive —à–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤** - –∑–∞–¥–∞—á–∏, —á–∞—Ç—ã, –≤—Ö–æ–¥—ã –≤ —Å–∏—Å—Ç–µ–º—É
- **SMTP –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Yandex –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
notificationService/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go             # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.go           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ email_service.go    # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ email
‚îÇ       ‚îî‚îÄ‚îÄ kafka_consumer.go   # Kafka consumer
‚îú‚îÄ‚îÄ templates/                  # HTML —à–∞–±–ª–æ–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ new_task.html          # –®–∞–±–ª–æ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–¥–∞—á–∞—Ö
‚îÇ   ‚îú‚îÄ‚îÄ new_chat.html          # –®–∞–±–ª–æ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —á–∞—Ç–∞—Ö
‚îÇ   ‚îî‚îÄ‚îÄ login.html             # –®–∞–±–ª–æ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤—Ö–æ–¥–µ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ README.md
```

## üìß –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (new_task)
**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- –ò–º—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –∑–∞–¥–∞—á–∏
- –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–¥–∞—á—É –≤ —Å–∏—Å—Ç–µ–º–µ

### 2. –ù–æ–≤—ã–π —á–∞—Ç (new_chat)
**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
- –ò–º—è —Å–æ–∑–¥–∞—Ç–µ–ª—è/–¥–æ–±–∞–≤–∏–≤—à–µ–≥–æ
- –¢–∏–ø —á–∞—Ç–∞ (–ª–∏—á–Ω—ã–π/–≥—Ä—É–ø–ø–æ–≤–æ–π)

### 3. –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (user_login)
**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- IP –∞–¥—Ä–µ—Å
- –ë—Ä–∞—É–∑–µ—Ä –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- –í—Ä–µ–º—è –≤—Ö–æ–¥–∞

## üé® HTML —à–∞–±–ª–æ–Ω—ã

### –î–∏–∑–∞–π–Ω —à–∞–±–ª–æ–Ω–æ–≤
- **Responsive –¥–∏–∑–∞–π–Ω** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å** - Material Design —ç–ª–µ–º–µ–Ω—Ç—ã
- **–ë—Ä–µ–Ω–¥–∏–Ω–≥ TeamMessenger** - —Ñ–∏—Ä–º–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ –ª–æ–≥–æ—Ç–∏–ø
- **Dark/Light —Ç–µ–º—ã** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–µ–º –ø–æ—á—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–∞
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamMessenger - {{.Title}}</title>
    <style>
        /* Responsive CSS —Å—Ç–∏–ª–∏ */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TeamMessenger</h1>
        </div>
        <div class="content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        </div>
        <div class="footer">
            <!-- –ü–æ–¥–≤–∞–ª —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ -->
        </div>
    </div>
</body>
</html>
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kafka

### Consumer Configuration
```go
type KafkaConsumer struct {
    consumer       sarama.ConsumerGroup
    emailService   *EmailService
    brokers        []string
    topic          string
    groupID        string
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

#### –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ Common –º–æ–¥—É–ª—è
```go
type BaseNotification struct {
    Type      string `json:"type"`
    Email     string `json:"email"`
    Timestamp int64  `json:"timestamp"`
}
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```go
func (nc *NotificationConsumer) processMessage(message *sarama.ConsumerMessage) error {
    var notification models.BaseNotification
    if err := json.Unmarshal(message.Value, &notification); err != nil {
        return err
    }

    switch notification.Type {
    case "new_task":
        return nc.handleNewTaskNotification(message.Value)
    case "new_chat":
        return nc.handleNewChatNotification(message.Value)
    case "user_login":
        return nc.handleLoginNotification(message.Value)
    default:
        return fmt.Errorf("unknown notification type: %s", notification.Type)
    }
}
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

Notification Service –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å:
- **Kafka** - –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **SMTP —Å–µ—Ä–≤–µ—Ä** - –æ—Ç–ø—Ä–∞–≤–∫–∞ email
- **Common –º–æ–¥—É–ª—å** - –º–æ–¥–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **Task Service** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö
- **Chat Service** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —á–∞—Ç–∞—Ö
- **User Service** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö

### –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```go
import (
    "common/kafka"
    "common/models"
)

// –ü—Ä–∏–º–µ—Ä –∏–∑ taskService
notification := models.NewTaskNotification{
    BaseNotification: models.BaseNotification{
        Type:      "new_task",
        Email:     executorEmail,
        Timestamp: time.Now().Unix(),
    },
    TaskTitle:       task.Title,
    TaskDescription: task.Description,
    CreatorName:     creatorName,
}

err := producer.SendNotification(notification)
```

## üß™ –¢–µ—Å—Ç—ã

### –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã

–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
go test -short ./tests/...
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Kafka –∏ SMTP —Å–µ—Ä–≤–µ—Ä–æ–º.

**–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Makefile (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```bash
make integration
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
1. –ü–æ–¥–Ω–∏–º–∞–µ—Ç docker-compose —Å Kafka, Zookeeper –∏ MailHog
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤:**
```bash
make integration TEST_ARGS="-v -run TestEmailService"
```

**–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ make):**
```bash
# –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
make up-integration

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
go test -tags=integration -v ./tests/integration/...

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
make down-integration
```

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö

**EmailService:**
- **SendNotification** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ (new_task, new_chat, user_login) —Å —Ä–µ–∞–ª—å–Ω—ã–º SMTP —Å–µ—Ä–≤–µ—Ä–æ–º
- **GenerateHTML** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π SMTP —Å–µ—Ä–≤–µ—Ä, –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**KafkaConsumer:**
- **ProcessMessage** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Kafka –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **ParseNotification** - –ø–∞—Ä—Å–∏–Ω–≥ Kafka —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **NewKafkaConsumer** - —Å–æ–∑–¥–∞–Ω–∏–µ consumer —Å —Ä–µ–∞–ª—å–Ω—ã–º Kafka
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π Kafka, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON, –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

`docker-compose.integration.yml` –ø–æ–¥–Ω–∏–º–∞–µ—Ç:
- **Kafka** –Ω–∞ –ø–æ—Ä—Ç—É 9092
- **Zookeeper** –¥–ª—è Kafka
- **MailHog** –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 1025 (SMTP) –∏ 8025 (Web UI) - —Ç–µ—Å—Ç–æ–≤—ã–π SMTP —Å–µ—Ä–≤–µ—Ä

–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ (–Ω–µ—Ç persistent volumes). –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—á–∏—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.