# WAF Rules - Block malicious requests

# Block requests with suspicious patterns in URI
# SQL Injection patterns
set $block_sql_injections 0;
if ($query_string ~* "union.*select.*\(") { set $block_sql_injections 1; }
if ($query_string ~* "concat.*\(") { set $block_sql_injections 1; }
if ($query_string ~* "select.*from.*information_schema") { set $block_sql_injections 1; }
if ($query_string ~* "(;|'|\"|\-\-).*(\-\-|#|/\*)") { set $block_sql_injections 1; }

# XSS patterns
set $block_xss 0;
if ($query_string ~* "(<|%3C).*script.*(>|%3E)") { set $block_xss 1; }
if ($query_string ~* "javascript:") { set $block_xss 1; }
if ($query_string ~* "vbscript:") { set $block_xss 1; }
if ($query_string ~* "onload\s*=") { set $block_xss 1; }

# File injection patterns  
set $block_file_injections 0;
if ($query_string ~* "\.\./") { set $block_file_injections 1; }
if ($query_string ~* "\.\.%5C") { set $block_file_injections 1; }
if ($query_string ~* "/etc/passwd") { set $block_file_injections 1; }
if ($query_string ~* "/proc/self") { set $block_file_injections 1; }

# Block common exploit scanners and bad bots
set $block_bad_bots 0;
if ($http_user_agent ~* (nikto|sqlmap|nmap|masscan|zgrab|nuclei|gobuster|dirbuster)) { set $block_bad_bots 1; }
if ($http_user_agent ~* (havij|appscan|w3af|netsparker|acunetix)) { set $block_bad_bots 1; }
if ($http_user_agent = "") { set $block_bad_bots 1; }

# Combined block check (used in location blocks)
set $waf_block 0;
if ($block_sql_injections = 1) { set $waf_block 1; }
if ($block_xss = 1) { set $waf_block 1; }
if ($block_file_injections = 1) { set $waf_block 1; }
if ($block_bad_bots = 1) { set $waf_block 1; }

